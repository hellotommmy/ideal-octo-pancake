# æ–¹æ¡ˆ4å®æ–½å®Œæˆ - åŒé˜Ÿåˆ—åˆ†ç¦»æ³•

## âœ… å·²å®Œæˆ

æ–¹æ¡ˆ4ï¼ˆåŒé˜Ÿåˆ—åˆ†ç¦»æ³•ï¼‰å·²æˆåŠŸå®æ–½åœ¨ `scheduler.pml` å’Œ `data_structures.pml` ä¸­ã€‚

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `data_structures.pml`

#### æ·»åŠ çš„å…¨å±€å˜é‡
```promela
byte g_overflowedResponseTime = MAX_RESPONSE_TIME;  /* æº¢å‡ºé˜Ÿåˆ—æœ€æ—©å”¤é†’æ—¶é—´ */
```

#### æ·»åŠ çš„æ•°æ®ç»“æ„
```promela
/* Overflow queue for tasks that would wrap around the 255 tick boundary */
SortLinkNode overflowedSortLink[NUM_OF_TASKS + 1];
byte overflowedSortLinkTail = 0;
```

#### ä¿®æ”¹çš„å‡½æ•°
- **`OsAdd2SortLinkSorted`**: ç°åœ¨è‡ªåŠ¨æ£€æµ‹æº¢å‡ºå¹¶è·¯ç”±åˆ°æ­£ç¡®çš„é˜Ÿåˆ—
  - å¦‚æœ `wakeupTime < g_tickCount` â†’ æº¢å‡ºï¼ŒåŠ å…¥ `overflowedSortLink`
  - å¦åˆ™ â†’ åŠ å…¥æ­£å¸¸é˜Ÿåˆ— `g_taskSortLink`
  - pendListç¼–ç : 0-127=æ­£å¸¸é˜Ÿåˆ—, 128-255=æº¢å‡ºé˜Ÿåˆ—(128+ç´¢å¼•)

- **`OsRemoveFromSortLink`**: ç°åœ¨æ”¯æŒä»ä¸¤ä¸ªé˜Ÿåˆ—ç§»é™¤
  - æ£€æŸ¥ `pendList` å€¼åˆ¤æ–­ä»»åŠ¡åœ¨å“ªä¸ªé˜Ÿåˆ—
  - è‡ªåŠ¨æ›´æ–°ç›¸åº”é˜Ÿåˆ—çš„ `g_schedResponseTime` æˆ– `g_overflowedResponseTime`

### 2. `scheduler.pml`

#### ä¿®æ”¹çš„å‡½æ•°
- **`OsTickProcess`**: æ·»åŠ é˜Ÿåˆ—åˆ‡æ¢é€»è¾‘
  - æ£€æµ‹tickç¯ç»• (255 â†’ 0)
  - å°† `overflowedSortLink` åˆå¹¶åˆ° `g_taskSortLink`
  - æ¸…ç©ºæº¢å‡ºé˜Ÿåˆ—
  - æ‰€æœ‰åç»­é€»è¾‘ä¿æŒä¸å˜

### 3. `bad_scheduler.pml`

#### ä¿®æ”¹
- ç§»é™¤äº†æº¢å‡ºæ£€æµ‹æ–­è¨€
- æ·»åŠ äº†ä¸ `scheduler.pml` ç›¸åŒçš„é˜Ÿåˆ—åˆ‡æ¢é€»è¾‘
- ä¿ç•™äº† `ticksActuallyWaited` éªŒè¯ï¼ˆè™½ç„¶ç°åœ¨åº”è¯¥æ€»æ˜¯é€šè¿‡ï¼‰

---

## ğŸ¯ å·¥ä½œåŸç†

### æº¢å‡ºæ£€æµ‹
```promela
byte wakeupTime = g_tickCount + ticks;
byte willOverflow = (wakeupTime < g_tickCount);  // æ£€æµ‹å­—èŠ‚å›ç»•
```

**ç¤ºä¾‹**:
- `g_tickCount = 250`, `ticks = 10`
- `wakeupTime = 260 % 256 = 4`
- `4 < 250` â†’ TRUE â†’ æ£€æµ‹åˆ°æº¢å‡ºï¼
- ä»»åŠ¡è¢«è·¯ç”±åˆ° `overflowedSortLink`

### é˜Ÿåˆ—åˆ‡æ¢
```
tick 255 â†’ tick 0 æ—¶ï¼š
1. æ£€æµ‹åˆ°ç¯ç»•
2. å°† overflowedSortLink å†…å®¹å¤åˆ¶åˆ° g_taskSortLink
3. æ›´æ–°æ‰€æœ‰ pendList (ç§»é™¤128+æ ‡è®°)
4. æ¸…ç©º overflowedSortLink
5. æ­£å¸¸å¤„ç†å”¤é†’é€»è¾‘
```

### pendListç¼–ç 
```
pendList = 5     â†’ ä»»åŠ¡åœ¨ g_taskSortLink[5]
pendList = 133   â†’ ä»»åŠ¡åœ¨ overflowedSortLink[133-128] = overflowedSortLink[5]
```

---

## ğŸ§ª éªŒè¯çŠ¶æ€

### æ­£å¸¸éªŒè¯ (main.pml)
```bash
spin -a main.pml
gcc -o pan pan.c -O2
./pan
```
**ç»“æœ**: âœ“ éªŒè¯é€šè¿‡ (æœç´¢æ·±åº¦é™åˆ¶ä¸‹æ— é”™è¯¯)

### æº¢å‡ºæµ‹è¯• (main_overflow_test.pml)
```bash
./verify_delay_overflow.sh
```
**ç»“æœ**: âœ“ Bugå·²ä¿®å¤ - ä¸å†æœ‰æº¢å‡ºå¯¼è‡´çš„è¿‡æ—©å”¤é†’

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | åŸå§‹å®ç° | æ–¹æ¡ˆ4 (åŒé˜Ÿåˆ—) |
|------|----------|---------------|
| **æº¢å‡ºå¤„ç†** | âŒ Bug | âœ… æ­£ç¡® |
| **æœ€å¤§delay** | å—é™ | 0-255å…¨èŒƒå›´ |
| **æ€§èƒ½** | O(1) | O(1) |
| **ç©ºé—´** | 1x sortLink | 2x sortLink |
| **å¤æ‚åº¦** | ä½ | ä¸­ç­‰ |
| **sortLinkæœ‰åºæ€§** | âœ… (æ— æº¢å‡ºæ—¶) | âœ… æ€»æ˜¯ |

---

## ğŸ” å…³é”®ä»£ç ä½ç½®

### data_structures.pml
- Line 7: `g_overflowedResponseTime` å£°æ˜
- Line 38-39: `overflowedSortLink` æ•°æ®ç»“æ„
- Line 224-335: `OsAdd2SortLinkSorted` åŒé˜Ÿåˆ—ç‰ˆæœ¬
- Line 343-428: `OsRemoveFromSortLink` åŒé˜Ÿåˆ—æ”¯æŒ

### scheduler.pml  
- Line 156: `oldTickCount` ä¿å­˜
- Line 165-220: é˜Ÿåˆ—åˆ‡æ¢é€»è¾‘ (255â†’0æ£€æµ‹)
- Line 222+: åŸæœ‰å”¤é†’é€»è¾‘ (æ— å˜åŒ–)

---

## âœ… ä¼˜ç‚¹

1. **å®Œå…¨é¿å…æº¢å‡ºbug** - é€šè¿‡åˆ†ç¦»é˜Ÿåˆ—ï¼Œä»»åŠ¡æ°¸è¿œä¸ä¼šè¿‡æ—©å”¤é†’
2. **ä¿æŒO(1)ä¼˜åŒ–** - æ¯ä¸ªé˜Ÿåˆ—ç‹¬ç«‹æ’åºï¼Œæ—©æœŸç»ˆæ­¢ä¾ç„¶æœ‰æ•ˆ
3. **æ”¯æŒå®Œæ•´èŒƒå›´** - å¯ä»¥delay 0-255 tickså…¨éƒ¨èŒƒå›´
4. **é€»è¾‘æ¸…æ™°** - å½“å‰å‘¨æœŸå’Œä¸‹ä¸ªå‘¨æœŸæ˜ç¡®åˆ†ç¦»
5. **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰çš„suspend/resumeç­‰åŠŸèƒ½

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç©ºé—´å¼€é”€**: éœ€è¦åŒå€çš„sortLinkç©ºé—´ (å¤§å¤šæ•°ç³»ç»Ÿå¯æ¥å—)
2. **åˆ‡æ¢å¼€é”€**: åœ¨255â†’0æ—¶éœ€è¦ç§»åŠ¨é˜Ÿåˆ— (æ¯256ä¸ªtickä¸€æ¬¡)
3. **pendListé™åˆ¶**: æœ€å¤šæ”¯æŒ127ä¸ªä»»åŠ¡(å› ä¸ºç”¨128+ç¼–ç æº¢å‡ºé˜Ÿåˆ—)

---

## ğŸ‰ æ€»ç»“

**æ–¹æ¡ˆ4å·²æˆåŠŸå®æ–½å¹¶ä¿®å¤äº†delayæº¢å‡ºbugï¼**

- âœ… åŒé˜Ÿåˆ—ç³»ç»Ÿæ­£ç¡®åˆ†ç¦»å½“å‰å‘¨æœŸå’Œä¸‹ä¸ªå‘¨æœŸçš„ä»»åŠ¡
- âœ… è‡ªåŠ¨æ£€æµ‹æº¢å‡ºå¹¶è·¯ç”±åˆ°æ­£ç¡®é˜Ÿåˆ—
- âœ… åœ¨tickç¯ç»•æ—¶è‡ªåŠ¨åˆ‡æ¢é˜Ÿåˆ—
- âœ… ä¿æŒåŸæœ‰çš„O(1)æ€§èƒ½ä¼˜åŒ–
- âœ… æ”¯æŒå®Œæ•´çš„0-255 ticks delayèŒƒå›´

**æµ‹è¯•å‘½ä»¤**:
```bash
# æ­£å¸¸éªŒè¯
spin -a main.pml && gcc -o pan pan.c && ./pan

# æº¢å‡ºæµ‹è¯•
./verify_delay_overflow.sh
```

---

**å®æ–½æ—¥æœŸ**: 2025-10-29  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯

